<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Service - Pakhomo Jobs</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            line-height: 1.6;
            color: #1a1a1a;
            background: linear-gradient(135deg, #667eea, #764ba2);
            min-height: 100vh;
            padding: 20px;
        }
        
        .booking-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 60px rgba(0,0,0,0.2);
            overflow: hidden;
            position: relative;
        }
        
        .booking-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 2rem;
            text-align: center;
            color: white;
        }
        
        .logo {
            font-size: 1.8rem;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-decoration: none;
        }

        .booking-header h1 {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }
        
        .booking-header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .progress-bar {
            background: rgba(255,255,255,0.2);
            height: 4px;
            margin-top: 1.5rem;
            border-radius: 2px;
            overflow: hidden;
        }
        
        .progress-fill {
            background: white;
            height: 100%;
            width: 20%;
            transition: width 0.3s ease;
        }
        
        .form-container {
            padding: 2rem;
        }
        
        .form-step {
            display: none;
            animation: slideIn 0.3s ease-in-out;
        }
        
        .form-step.active {
            display: block;
        }
        
        .step-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: #1a1a1a;
        }
        
        .step-subtitle {
            color: #666;
            margin-bottom: 2rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
        }
        
        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .service-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .service-option {
            background: #f8f9ff;
            border: 2px solid #e1e5e9;
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .service-option:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }
        
        .service-option.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
        }
        
        .service-option.selected::after {
            content: '‚úì';
            position: absolute;
            top: 10px;
            right: 15px;
            background: #667eea;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
        }
        
        .service-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            display: block;
        }
        
        .service-name {
            font-weight: 600;
            color: #333;
            font-size: 1rem;
        }
        
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.8rem;
            background: #f8f9ff;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .checkbox-item:hover {
            background: #e8f2ff;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #667eea;
        }
        
        .radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .radio-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.8rem 1.2rem;
            background: #f8f9ff;
            border: 2px solid #e1e5e9;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .radio-item:hover {
            border-color: #667eea;
        }
        
        .radio-item input[type="radio"]:checked + label {
            background: #667eea;
            color: white;
        }
        
        .radio-item input[type="radio"] {
            accent-color: #667eea;
        }
        
        .form-buttons {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #e1e5e9;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            flex: 1;
        }
        
        .btn-secondary {
            background: #f1f3f4;
            color: #666;
            min-width: 100px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .emergency-notice {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .emergency-notice strong {
            display: block;
            margin-bottom: 0.5rem;
        }
        
        .price-estimate {
            background: linear-gradient(135deg, #51cf66, #40c057);
            color: white;
            padding: 1.5rem;
            border-radius: 15px;
            margin: 2rem 0;
            text-align: center;
        }
        
        .price-estimate h3 {
            margin-bottom: 0.5rem;
        }
        
        .price-range {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }
        
        .price-note {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .summary-section {
            background: #f8f9ff;
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 2rem;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e1e5e9;
        }
        
        .summary-item:last-child {
            border-bottom: none;
            font-weight: 600;
            color: #667eea;
        }
        
        .loading-spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid #ffffff;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .success-message {
            text-align: center;
            padding: 2rem;
        }
        
        .success-icon {
            font-size: 4rem;
            color: #51cf66;
            margin-bottom: 1rem;
        }
        
        .whatsapp-preview {
            background: #e8f5e8;
            border-left: 4px solid #25D366;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 0 10px 10px 0;
            font-family: monospace;
            font-size: 0.9rem;
            white-space: pre-line;
        }
        
        @media (max-width: 768px) {
            .booking-container {
                margin: 10px;
            }
            
            .form-container {
                padding: 1.5rem;
            }
            
            .service-grid {
                grid-template-columns: 1fr;
            }
            
            .checkbox-group {
                grid-template-columns: 1fr;
            }
            
            .radio-group {
                flex-direction: column;
            }
            
            .form-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="booking-container">
        <div class="booking-header">
            <a href="index.html" class="logo">üè† Pakhomo Jobs</a>
            <p style="margin-top: 1rem;">Tell us what you need, and we'll connect you with the perfect helper</p>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>
        
        <div class="form-container">
            <form id="bookingForm" action="https://formspree.io/f/xvgqbeyq" method="POST">
            <!-- Step 1: Service Selection -->
            <div class="form-step active" id="step1">
                <h2 class="step-title">What service do you need?</h2>
                <p class="step-subtitle">Select the type of help you're looking for</p>
                
                <div class="service-grid">
                    <div class="service-option" data-service="domestic">
                        <span class="service-icon">üè†</span>
                        <div class="service-name">Domestic Help</div>
                    </div>
                    <div class="service-option" data-service="hospitality">
                        <span class="service-icon">üçΩÔ∏è</span>
                        <div class="service-name">Hospitality Staff</div>
                    </div>
                    <div class="service-option" data-service="culinary">
                        <span class="service-icon">üë®‚Äçüç≥</span>
                        <div class="service-name">Chef/Cook</div>
                    </div>
                    <div class="service-option" data-service="security">
                        <span class="service-icon">üõ°Ô∏è</span>
                        <div class="service-name">Security Guard</div>
                    </div>
                    <div class="service-option" data-service="driver">
                        <span class="service-icon">üöó</span>
                        <div class="service-name">Driver</div>
                    </div>
                    <div class="service-option" data-service="childcare">
                        <span class="service-icon">üë©‚Äçüë¶</span>
                        <div class="service-name">Childcare</div>
                    </div>
                    <div class="service-option" data-service="office">
                        <span class="service-icon">üè¢</span>
                        <div class="service-name">Office Support</div>
                    </div>
                    <div class="service-option" data-service="emergency">
                        <span class="service-icon">üö®</span>
                        <div class="service-name">Emergency Service</div>
                    </div>
                </div>
                
                <div class="emergency-notice" id="emergencyNotice" style="display: none;">
                    <strong>üö® Emergency Service Selected</strong>
                    For immediate assistance, call our 24/7 hotline: +265 988 11 49 09
                </div>
            </div>
            
            <!-- Step 2: Specific Requirements -->
            <div class="form-step" id="step2">
                <h2 class="step-title">Specific Requirements</h2>
                <p class="step-subtitle">What specific tasks do you need help with?</p>
                
                <div class="checkbox-group" id="specificRequirements">
                    <!-- Dynamic content based on service selection -->
                </div>
                
                <div class="form-group">
                    <label class="form-label">Additional Details (Optional)</label>
                    <textarea class="form-input form-textarea" id="additionalDetails" placeholder="Please provide any additional information about your requirements..."></textarea>
                </div>
            </div>
            
            <!-- Step 3: Timing & Duration -->
            <div class="form-step" id="step3">
                <h2 class="step-title">When do you need help?</h2>
                <p class="step-subtitle">Select your preferred timing and duration</p>
                
                <div class="form-group">
                    <label class="form-label">Service Type</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" name="serviceType" value="one-time" id="oneTime">
                            <label for="oneTime">One-time Service</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="serviceType" value="regular" id="regular">
                            <label for="regular">Regular Service</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="serviceType" value="live-in" id="liveIn">
                            <label for="liveIn">Live-in Help</label>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Preferred Start Date</label>
                    <input type="date" class="form-input" id="startDate" min="">
                </div>
                
                <div class="form-group" id="scheduleOptions">
                    <label class="form-label">Preferred Schedule</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" name="schedule" value="morning" id="morning">
                            <label for="morning">Morning (8AM-12PM)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="schedule" value="afternoon" id="afternoon">
                            <label for="afternoon">Afternoon (1PM-5PM)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="schedule" value="evening" id="evening">
                            <label for="evening">Evening (6PM-10PM)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="schedule" value="fullday" id="fullday">
                            <label for="fullday">Full Day</label>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">How many hours per day? (Estimate)</label>
                    <select class="form-input" id="hoursPerDay">
                        <option value="">Select hours</option>
                        <option value="2-4">2-4 hours</option>
                        <option value="4-6">4-6 hours</option>
                        <option value="6-8">6-8 hours</option>
                        <option value="8+">8+ hours (Full time)</option>
                    </select>
                </div>
            </div>
            
            <!-- Step 4: Location & Contact -->
            <div class="form-step" id="step4">
                <h2 class="step-title">Location & Contact Details</h2>
                <p class="step-subtitle">Where should our helper report, and how can we reach you?</p>
                
                <div class="form-group">
                    <label class="form-label">Your Name *</label>
                    <input type="text" class="form-input" id="clientName" placeholder="Full name" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Phone Number *</label>
                    <input type="tel" class="form-input" id="clientPhone" placeholder="+265 xxx xxx xxx" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" class="form-input" id="clientEmail" placeholder="your.email@example.com">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Service Location *</label>
                    <select class="form-input" id="location" required>
                        <option value="">Select location</option>
                        <option value="Lilongwe">Lilongwe</option>
                        <option value="Blantyre">Blantyre</option>
                        <option value="Mzuzu">Mzuzu</option>
                        <option value="Zomba">Zomba</option>
                        <option value="Kasungu">Kasungu</option>
                        <option value="Mangochi">Mangochi</option>
                        <option value="Salima">Salima</option>
                        <option value="Balaka">Balaka</option>
                        <option value="Karonga">Karonga</option>
                        <option value="Other">Other (specify in address)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Detailed Address *</label>
                    <textarea class="form-input form-textarea" id="address" placeholder="House/building number, street, area, landmarks..." required style="min-height: 80px;"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Special Requirements</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="english" value="english">
                            <label for="english">Must speak English</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="experience" value="experience">
                            <label for="experience">Minimum 2 years experience</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="references" value="references">
                            <label for="references">Must have references</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="transport" value="transport">
                            <label for="transport">Must have own transport</label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Step 5: Review & Confirm -->
            <div class="form-step" id="step5">
                <h2 class="step-title">Review Your Request</h2>
                <p class="step-subtitle">Please review your service request before submitting</p>
                
                <div class="summary-section" id="requestSummary">
                    <!-- Dynamic summary content -->
                </div>
                
                <div class="price-estimate" id="priceEstimate">
                    <h3>üí∞ Estimated Cost</h3>
                    <div class="price-range" id="priceRange">MWK 15,000 - 25,000</div>
                    <div class="price-note">*Final price depends on specific requirements and negotiations</div>
                </div>
                
                <div class="whatsapp-preview">
                    <strong>üì± Your request will be sent via WhatsApp:</strong><br><br>
                    <div id="whatsappPreview"></div>
                </div>
                
                <div class="form-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="termsAgree" required>
                        <label for="termsAgree">I agree to Pakhomo Jobs terms and conditions</label>
                    </div>
                </div>
            </div>
            
            <!-- Success Step -->
            <div class="form-step" id="stepSuccess">
                <div class="success-message">
                    <div class="success-icon">‚úì</div>
                    <h2>Booking Request Sent!</h2>
                    <p>Thank you! We've received your request and will contact you soon to confirm.</p>
                    <div class="success-actions" style="margin-top: 1.5rem; display: flex; justify-content: center; gap: 1rem;">
                        <button type="button" class="btn btn-secondary" onclick="location.href='index.html'">‚Üê Back to Home</button>
                        <button type="button" class="btn btn-primary" id="whatsappBtn" onclick="sendWhatsAppMessage()">
                            Send a Copy via WhatsApp
                        </button>
                    </div>
                </div>
            </div>

            </form>
        </div>
        <div class="navigation-buttons" id="navigationButtons">
            <button type="button" class="btn btn-secondary" id="prevBtn" onclick="previousStep()">‚Üê Previous</button>
            <button type="button" class="btn btn-primary" id="nextBtn" onclick="nextStep()">
                Next ‚Üí
                <span id="loadingSpinner" class="loading-spinner" style="display: none;"></span>
            </button>
        </div>
    </div>

    <script>
        let currentStep = 1;
        const totalSteps = 5;
        let formData = {};

        // Service requirements mapping
        const serviceRequirements = {
            domestic: ['House cleaning', 'Laundry & ironing', 'Cooking meals', 'Childcare', 'Elderly care', 'Pet care', 'Garden maintenance', 'Shopping & errands'],
            hospitality: ['Waiter/Waitress', 'Kitchen assistant', 'Housekeeping', 'Reception', 'Event service', 'Bar tender', 'Room service', 'Cleaning staff'],
            culinary: ['Traditional Malawian dishes', 'International cuisine', 'Meal planning', 'Kitchen management', 'Food preparation', 'Catering events', 'Special diets', 'Baking'],
            security: ['Day shift guard', 'Night shift guard', 'Event security', 'Patrol services', 'Access control', 'CCTV monitoring', 'Emergency response', 'Property protection'],
            driver: ['Personal driver', 'Delivery services', 'Airport transfers', 'Shopping trips', 'School runs', 'Business meetings', 'Long distance travel', 'Night driving'],
            childcare: ['Babysitting (hourly)', 'Full-time nanny', 'After school care', 'Weekend care', 'Night care', 'Educational activities', 'Play supervision', 'Meal preparation for kids'],
            office: ['Office cleaning', 'Reception duties', 'File organization', 'Mail handling', 'Basic admin tasks', 'Meeting room setup', 'Equipment maintenance', 'Visitor management'],
            emergency: ['Immediate cleaning help', 'Last-minute childcare', 'Event staff urgently needed', 'Security guard ASAP', 'Driver for emergency', 'Same-day service required']
        };

        // Price estimates (MWK per month for regular service)
        const priceEstimates = {
            domestic: { min: 15000, max: 35000 },
            hospitality: { min: 20000, max: 45000 },
            culinary: { min: 25000, max: 50000 },
            security: { min: 30000, max: 60000 },
            driver: { min: 35000, max: 70000 },
            childcare: { min: 20000, max: 40000 },
            office: { min: 18000, max: 35000 },
            emergency: { min: 5000, max: 15000 }
        };

        document.addEventListener('DOMContentLoaded', function() {
            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').min = today;

            // Service selection handlers
            document.querySelectorAll('.service-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.service-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    formData.selectedService = this.dataset.service;
                    const emergencyNotice = document.getElementById('emergencyNotice');
                    emergencyNotice.style.display = this.dataset.service === 'emergency' ? 'block' : 'none';
                    updateNextButton();
                });
            });

            // Add event listeners to all relevant inputs for validation
            document.querySelectorAll('input, select, textarea').forEach(input => {
                input.addEventListener('input', updateNextButton);
                input.addEventListener('change', updateNextButton);
            });

            // Phone number formatting
            document.getElementById('clientPhone').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value && !value.startsWith('265')) {
                    if (value.startsWith('0')) {
                        value = '265' + value.substring(1);
                    } else if (value.length === 9) {
                        value = '265' + value;
                    }
                }
                if (value.length >= 3) {
                    value = '+' + value.substring(0, 3) + ' ' + value.substring(3);
                }
                e.target.value = value;
            });

            // Keyboard navigation
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey && document.activeElement.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                    if (!document.getElementById('nextBtn').disabled) {
                        nextStep();
                    }
                }
            });

            // Prevent accidental page refresh
            window.addEventListener('beforeunload', function(e) {
                if (currentStep > 1 && currentStep <= totalSteps) {
                    e.preventDefault();
                    e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
                    return e.returnValue;
                }
            });

            // Auto-save every 30 seconds
            setInterval(autoSave, 30000);

            // Initialize the first step
            showStep(currentStep);
        });

        function nextStep() {
            if (!validateCurrentStep()) return;
            if (currentStep < totalSteps) {
                saveCurrentStepData();
                currentStep++;
                showStep(currentStep);
            } else if (currentStep === totalSteps) {
                submitForm();
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
            }
        }

        function showStep(step) {
            const steps = document.querySelectorAll('.form-step');
            const progressBar = document.querySelector('.progress-fill');
            const navButtons = document.getElementById('navigationButtons');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            steps.forEach(s => s.classList.remove('active'));

            if (step > totalSteps) { // Success step
                document.getElementById('stepSuccess').classList.add('active');
                navButtons.style.display = 'none';
            } else {
                const currentStepEl = document.getElementById(`step${step}`);
                if (currentStepEl) currentStepEl.classList.add('active');
                navButtons.style.display = 'flex';
            }

            const progress = Math.min(100, (step - 1) / (totalSteps - 1) * 100);
            progressBar.style.width = `${progress}%`;

            prevBtn.style.display = step === 1 ? 'none' : 'inline-flex';
            nextBtn.style.display = step > totalSteps ? 'none' : 'inline-flex';

            if (step === totalSteps) {
                nextBtn.innerHTML = 'Submit & Send via WhatsApp';
                nextBtn.onclick = submitForm;
            } else {
                nextBtn.innerHTML = 'Next ‚Üí';
                nextBtn.onclick = nextStep;
            }

            if (step === 2) populateSpecificRequirements();
            if (step === 5) generateSummary();

            updateNextButton();
        }

        function updateNextButton() {
            const nextBtn = document.getElementById('nextBtn');
            if (nextBtn) {
                nextBtn.disabled = !validateCurrentStepSilent();
            }
        }

        function validateCurrentStep() {
            const isValid = validateCurrentStepSilent();
            if (!isValid) {
                // You can add specific alert messages here if needed
                alert('Please complete all required fields before proceeding.');
            }
            return isValid;
        }

        function validateCurrentStepSilent() {
            const stepEl = document.getElementById(`step${currentStep}`);
            if (!stepEl) return false;

            switch (currentStep) {
                case 1: return !!formData.selectedService;
                case 2: {
                    const checkboxes = stepEl.querySelectorAll('input[type="checkbox"]');
                    if (checkboxes.length === 0) return true; // No requirements, so it's valid
                    return stepEl.querySelectorAll('input[type="checkbox"]:checked').length > 0;
                }
                case 3: return stepEl.querySelector('input[name="serviceType"]:checked') && document.getElementById('startDate').value && document.getElementById('hoursPerDay').value;
                case 4: return document.getElementById('clientName').value.trim() && document.getElementById('clientPhone').value.trim() && document.getElementById('location').value && document.getElementById('address').value.trim();
                case 5: return document.getElementById('termsAgree').checked;
                default: return false;
            }
        }

        function saveCurrentStepData() {
            const stepEl = document.getElementById(`step${currentStep}`);
            switch (currentStep) {
                case 1: break; // Saved on click
                case 2:
                    formData.specificRequirements = Array.from(stepEl.querySelectorAll('input:checked')).map(cb => cb.nextElementSibling.textContent);
                    break;
                case 3:
                    formData.serviceType = stepEl.querySelector('input[name="serviceType"]:checked').value;
                    formData.startDate = document.getElementById('startDate').value;
                    formData.hoursPerDay = document.getElementById('hoursPerDay').value;
                    formData.schedule = stepEl.querySelector('input[name="schedule"]:checked')?.value || 'flexible';
                    formData.specialRequirements = Array.from(stepEl.querySelectorAll('input[name="specialRequirements"]:checked')).map(cb => cb.value);
                    break;
                case 4:
                    formData.clientName = document.getElementById('clientName').value;
                    formData.clientPhone = document.getElementById('clientPhone').value;
                    formData.clientEmail = document.getElementById('clientEmail').value;
                    formData.location = document.getElementById('location').value;
                    formData.address = document.getElementById('address').value;
                    formData.additionalDetails = document.getElementById('additionalDetails').value;
                    break;
                case 5: break; // Agreement only
            }
            autoSave();
        }

        function populateSpecificRequirements() {
            const container = document.getElementById('specificRequirements');
            const requirements = serviceRequirements[formData.selectedService] || [];
            container.innerHTML = '';
            if (requirements.length === 0) {
                container.innerHTML = '<p>No specific requirements for this service. Click Next to continue.</p>';
            } else {
                requirements.forEach(req => {
                    const id = `req-${req.replace(/\s+/g, '-')}`;
                    container.innerHTML += `
                        <div class="checkbox-item">
                            <input type="checkbox" id="${id}" name="specificRequirement">
                            <label for="${id}">${req}</label>
                        </div>`;
                });
            }
        }

        function generateSummary() {
            const summaryContent = document.getElementById('requestSummary');
            const priceContainer = document.getElementById('priceRange');
            const whatsappPreview = document.getElementById('whatsappPreview');
            const serviceName = document.querySelector(`[data-service="${formData.selectedService}"] .service-name`).textContent;

            let summaryHTML = `
                <div class="summary-item"><span>Service Type:</span><span>${serviceName}</span></div>
                <div class="summary-item"><span>Specific Requirements:</span><span>${formData.specificRequirements.join(', ')}</span></div>
                <div class="summary-item"><span>Service Duration:</span><span>${formatServiceType(formData.serviceType)}</span></div>
                <div class="summary-item"><span>Start Date:</span><span>${formatDate(formData.startDate)}</span></div>
                <div class="summary-item"><span>Hours per Day:</span><span>${formData.hoursPerDay}</span></div>
                <div class="summary-item"><span>Location:</span><span>${formData.location}</span></div>
                <div class="summary-item"><span>Contact:</span><span>${formData.clientName} - ${formData.clientPhone}</span></div>`;

            if (formData.schedule && formData.schedule !== 'flexible') {
                summaryHTML += `<div class="summary-item"><span>Preferred Schedule:</span><span>${formatSchedule(formData.schedule)}</span></div>`;
            }
            if (formData.specialRequirements && formData.specialRequirements.length > 0) {
                summaryHTML += `<div class="summary-item"><span>Special Requirements:</span><span>${formatSpecialRequirements(formData.specialRequirements)}</span></div>`;
            }
            summaryContent.innerHTML = summaryHTML;

            const prices = priceEstimates[formData.selectedService];
            let priceText = `MWK ${prices.min.toLocaleString()} - ${prices.max.toLocaleString()}`;
            if (formData.serviceType === 'one-time') priceText = `MWK ${Math.round(prices.min / 4).toLocaleString()} - ${Math.round(prices.max / 4).toLocaleString()}`;
            else if (formData.serviceType === 'live-in') priceText = `MWK ${Math.round(prices.max * 1.5).toLocaleString()} - ${Math.round(prices.max * 2).toLocaleString()}`;
            priceContainer.textContent = priceText;

            whatsappPreview.textContent = generateWhatsAppMessage();
        }

        function formatServiceType(type) {
            return { 'one-time': 'One-time Service', 'regular': 'Regular Service', 'live-in': 'Live-in Help' }[type] || type;
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }

        function formatSchedule(schedule) {
            return { 'morning': 'Morning (8AM-12PM)', 'afternoon': 'Afternoon (1PM-5PM)', 'evening': 'Evening (6PM-10PM)', 'fullday': 'Full Day' }[schedule] || schedule;
        }

        function formatSpecialRequirements(reqs) {
            const map = { 'english': 'Must speak English', 'experience': 'Minimum 2 years experience', 'references': 'Must have references', 'transport': 'Must have own transport' };
            return reqs.map(r => map[r] || r).join(', ');
        }

        function generateWhatsAppMessage() {
            const serviceName = document.querySelector(`[data-service="${formData.selectedService}"] .service-name`).textContent;
            let msg = `üè† *PAKHOMO JOBS - SERVICE REQUEST*\n\n`;
            msg += `üë§ *Client:* ${formData.clientName}\nüìû *Phone:* ${formData.clientPhone}\n`;
            if (formData.clientEmail) msg += `üìß *Email:* ${formData.clientEmail}\n`;
            msg += `\nüîß *SERVICE DETAILS:*\n‚Ä¢ Service Type: ${serviceName}\n‚Ä¢ Duration: ${formatServiceType(formData.serviceType)}\n‚Ä¢ Start Date: ${formatDate(formData.startDate)}\n‚Ä¢ Hours per Day: ${formData.hoursPerDay}\n`;
            if (formData.schedule && formData.schedule !== 'flexible') msg += `‚Ä¢ Preferred Schedule: ${formatSchedule(formData.schedule)}\n`;
            msg += `\nüìç *LOCATION:*\n‚Ä¢ City: ${formData.location}\n‚Ä¢ Address: ${formData.address}\n`;
            msg += `\nüìã *REQUIREMENTS:*\n‚Ä¢ ${formData.specificRequirements.join('\n‚Ä¢ ')}\n`;
            if (formData.specialRequirements && formData.specialRequirements.length > 0) msg += `\n‚≠ê *SPECIAL REQUIREMENTS:*\n‚Ä¢ ${formatSpecialRequirements(formData.specialRequirements).replace(/, /g, '\n‚Ä¢ ')}\n`;
            if (formData.additionalDetails) msg += `\nüí¨ *ADDITIONAL DETAILS:*\n${formData.additionalDetails}\n`;
            msg += `\n‚è∞ *Request submitted on:* ${new Date().toLocaleString('en-GB')}\n\n‚úÖ Please confirm receipt and provide next steps.`;
            return msg;
        }

        function submitForm() {
            const form = document.getElementById('bookingForm');
            const nextBtn = document.getElementById('nextBtn');
            const loadingSpinner = document.getElementById('loadingSpinner');

            nextBtn.disabled = true;
            // Update button text safely
            for (const node of nextBtn.childNodes) {
                if (node.nodeType === Node.TEXT_NODE && node.textContent.trim()) {
                    node.textContent = 'Submitting... ';
                    break;
                }
            }
            if (loadingSpinner) loadingSpinner.style.display = 'inline-block';

            saveCurrentStepData();
            const data = new FormData(form);
            
            // Append our formData object to the submission
            for (const key in formData) {
                data.append(key, formData[key]);
            }

            fetch(form.action, {
                method: 'POST',
                body: data,
                headers: {
                    'Accept': 'application/json'
                }
            }).then(response => {
                if (response.ok) {
                    currentStep++;
                    showStep(currentStep); // Show success screen
                } else {
                    response.json().then(data => {
                        if (Object.hasOwn(data, 'errors')) {
                            alert(data["errors"].map(error => error["message"]).join(", "));
                        } else {
                            alert('Oops! There was a problem submitting your form.');
                        }
                    });
                }
            }).catch(error => {
                alert('An error occurred. Please try again.');
            }).finally(() => {
                // Reset button state in case of error
                nextBtn.disabled = false;
                for (const node of nextBtn.childNodes) {
                    if (node.nodeType === Node.TEXT_NODE) {
                        node.textContent = 'Confirm & Book Now';
                        break;
                    }
                }
                if (loadingSpinner) loadingSpinner.style.display = 'none';
            });
        }

        function sendWhatsAppMessage() {
            const whatsappMessage = generateWhatsAppMessage();
            const encodedMessage = encodeURIComponent(whatsappMessage);
            const whatsappUrl = `https://wa.me/265988114909?text=${encodedMessage}`;
            window.open(whatsappUrl, '_blank');
        }

        function autoSave() {
            try {
                localStorage.setItem('bookingFormData', JSON.stringify(formData));
            } catch (e) {
                console.log('Auto-save not available');
            }
        }
    </script>
</body>
</html> 